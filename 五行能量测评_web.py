import streamlit as st
import time
from datetime import datetime
import hashlib
from urllib.parse import urlencode
import webbrowser

# ---------------------- æ ¸å¿ƒé…ç½®ï¼ˆä»…éœ€æ›¿æ¢è¿™1ä¸ªé“¾æ¥ï¼‰ ----------------------
# æ›¿æ¢æˆä½ é£ä¹¦å¤šç»´è¡¨æ ¼ç”Ÿæˆçš„è¡¨å•é“¾æ¥ï¼ï¼ï¼
FEISHU_FORM_URL = "https://harbdn8pugb.feishu.cn/share/base/form/shrcnVizRgVgqufFONcHQ6sIAYf"

# é˜²é‡å¤æäº¤ç¼“å­˜é”®
CACHE_KEY = "submitted_user"

# ---------------------- é¡µé¢ç¾åŒ–é…ç½® ----------------------
st.set_page_config(
    page_title="äº”è¡Œèƒ½é‡çŠ¶æ€æµ‹è¯„",
    layout="wide",
    page_icon="ğŸƒ"
)

# é¡¶éƒ¨äº”è¡Œå›¾æ ‡
st.markdown("""
<div style="text-align: center; margin-bottom: 20px;">
    <span style="font-size: 2.5em;">ğŸƒğŸ”¥ğŸŒğŸ’§ğŸ’›</span>
</div>
""", unsafe_allow_html=True)

st.title("ğŸŒ¿ äº”è¡Œèƒ½é‡çŠ¶æ€æµ‹è¯„")
st.markdown("#### å¡«å†™è¯´æ˜ï¼šæ ¹æ®è¿‘3ä¸ªæœˆçš„èº«ä½“çŠ¶æ€ï¼Œé€‰æ‹©å¯¹åº”çš„ç—‡çŠ¶ç¨‹åº¦")
st.divider()

# ---------------------- é˜²é‡å¤æäº¤é€»è¾‘ ----------------------
def get_user_unique_id():
    """ç”Ÿæˆç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼ˆè®¾å¤‡+ä¼šè¯ï¼‰"""
    session_id = st.session_state.get("session_id", str(time.time()))
    st.session_state["session_id"] = session_id
    return hashlib.md5(session_id.encode()).hexdigest()

def check_submitted():
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æäº¤"""
    user_id = get_user_unique_id()
    submitted_info = st.session_state.get(CACHE_KEY, {})
    return submitted_info.get(user_id, False)

def mark_submitted(wechat_name):
    """æ ‡è®°ç”¨æˆ·å·²æäº¤"""
    user_id = get_user_unique_id()
    if CACHE_KEY not in st.session_state:
        st.session_state[CACHE_KEY] = {}
    st.session_state[CACHE_KEY][user_id] = {
        "submitted": True,
        "wechat_name": wechat_name,
        "time": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    }

# ---------------------- é£ä¹¦è¡¨å•æäº¤ï¼ˆæ ¸å¿ƒï¼šé›¶é…ç½®è·³è½¬ï¼‰ ----------------------
def submit_to_feishu_form(wechat_name, element_results):
    """è·³è½¬é£ä¹¦è¡¨å•å¹¶é¢„å¡«æ•°æ®ï¼Œç›´æ¥å†™å…¥ä½ çš„è¡¨æ ¼"""
    try:
        # æ„é€ é¢„å¡«å‚æ•°ï¼ˆå­—æ®µåå¿…é¡»å’Œä½ é£ä¹¦è¡¨æ ¼åˆ—åå®Œå…¨ä¸€è‡´ï¼‰
        params = {
            "å¾®ä¿¡æ˜µç§°": wechat_name.strip(),
            "ç«": element_results["ç«"]["ç±»å‹"],
            "æœ¨": element_results["æœ¨"]["ç±»å‹"],
            "åœŸ": element_results["åœŸ"]["ç±»å‹"],
            "é‡‘": element_results["é‡‘"]["ç±»å‹"],
            "æ°´": element_results["æ°´"]["ç±»å‹"],
            "æäº¤æ—¶é—´": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }

        # æ‹¼æ¥å¸¦é¢„å¡«æ•°æ®çš„è¡¨å•é“¾æ¥
        full_url = f"{FEISHU_FORM_URL}?{urlencode(params)}"
        
        # æç¤ºç”¨æˆ·å¹¶è·³è½¬
        st.success("âœ… æµ‹è¯„ç»“æœå·²ç”Ÿæˆï¼æ­£åœ¨æ‰“å¼€é£ä¹¦è¡¨å•å®Œæˆæäº¤...")
        st.markdown(f"""
        <div style="padding: 10px; background-color: #f0f8fb; border-radius: 8px; margin: 10px 0;">
            <p>ğŸ‘‰ <b>ç‚¹å‡»ä¸‹æ–¹é“¾æ¥</b> å®Œæˆæœ€ç»ˆæäº¤ï¼ˆæ•°æ®å°†è‡ªåŠ¨å­˜å…¥é£ä¹¦è¡¨æ ¼ï¼‰</p>
            <a href="{full_url}" target="_blank" style="color: #165DFF; font-weight: bold;">{full_url}</a>
            <p>æäº¤åæˆªå›¾å‘ç»™ç­ç­è€å¸ˆå³å¯ âœ¨</p>
        </div>
        """, unsafe_allow_html=True)
        
        # è‡ªåŠ¨æ‰“å¼€æ–°æ ‡ç­¾é¡µï¼ˆæµè§ˆå™¨ä¼šè§¦å‘ï¼Œç”¨æˆ·åªéœ€ç‚¹ç¡®è®¤ï¼‰
        webbrowser.open_new_tab(full_url)
        return True
    except Exception as e:
        st.warning(f"è·³è½¬è¡¨å•å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥æäº¤ï¼š{str(e)}")
        return False

# ---------------------- å¾®ä¿¡æ˜µç§°å¡«å†™ ----------------------
wechat_name = st.text_input(
    "ğŸ“± è¯·è¾“å…¥ä½ çš„å¾®ä¿¡æ˜µç§°ï¼ˆå¿…å¡«ï¼‰",
    placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰-1ç­",
    key="wechat_name",
    help="å¡«å†™åæ‰èƒ½æäº¤æµ‹è¯„ç»“æœ"
)
st.divider()

# ---------------------- é¢˜ç›®é…ç½® ----------------------
QUESTIONS = {
    1: ["å¿ƒè·³çªç„¶åŠ å¿«ï¼Œæ„Ÿè§‰å¿ƒæ…Œæ…Œçš„ ğŸ’“", "ç«èƒ½é‡è¿‡å¼±"],
    2: ["èƒ¸å£æ€»æ˜¯è§‰å¾—æ€•å†·ï¼Œéœ€è¦é¢å¤–æ‚çƒ­ â„ï¸", "ç«èƒ½é‡è¿‡å¼±"],
    3: ["æ²¡æ´»åŠ¨ä¹Ÿçˆ±å‡ºè™šæ±—ï¼Œæµ‘èº«æ²¡åŠ›æ°” ğŸ’¦", "ç«èƒ½é‡è¿‡å¼±"],
    4: ["å¤œé‡Œç¡è§‰å®¹æ˜“é†’ï¼Œé†’åå¿ƒæ…Œéš¾å…¥ç¡ ğŸ˜´", "ç«èƒ½é‡è¿‡å¼±"],
    5: ["å¿ƒé‡Œçƒ¦èºä¸å®‰ï¼Œæ§åˆ¶ä¸ä½çš„å¿ƒçƒ¦ ğŸ˜ ", "ç«èƒ½é‡è¿‡å¼º"],
    6: ["èˆŒå°–å‘çº¢ï¼Œåå¤é•¿å£è…”æºƒç–¡ã€å£èˆŒç”Ÿç–® ğŸŒ¶ï¸", "ç«èƒ½é‡è¿‡å¼º"],
    7: ["æ‰‹å¿ƒè„šå¿ƒå‘çƒ­ï¼Œæ€»è§‰å¾—å¿ƒé‡Œç‡¥çƒ­ ğŸ¥µ", "ç«èƒ½é‡è¿‡å¼º"],
    8: ["å®¹æ˜“è«åç„¦è™‘ï¼Œä¸€ç‚¹å°äº‹å°±åç«‹éš¾å®‰ ğŸ˜°", "ç«èƒ½é‡è¿‡å¼º"],
    9: ["èƒ¸å£ä¸¤ä¾§èƒ€ç—›ï¼Œæƒ…ç»ªä¸å¥½æ—¶æ›´æ˜æ˜¾ ğŸ˜£", "æœ¨èƒ½é‡è¿‡å¼±"],
    10: ["å°è…¹éƒ¨å†·ç—›ã€å èƒ€ï¼Œçƒ­æ•·åä¼šç¼“è§£ ğŸ§Š", "æœ¨èƒ½é‡è¿‡å¼±"],
    11: ["æƒ…ç»ªä½è½æ²¡ç²¾ç¥ï¼Œå¯¹ä»€ä¹ˆäº‹éƒ½æä¸èµ·åŠ² ğŸ˜", "æœ¨èƒ½é‡è¿‡å¼±"],
    12: ["æ‰‹è„šå‘éº»ï¼Œç­‹è„‰å‘ç´§ï¼Œå¤©å†·æ—¶åŠ é‡ ğŸ¥¶", "æœ¨èƒ½é‡è¿‡å¼±"],
    13: ["çœ¼ç›å¹²æ¶©ã€å‘ç–¼ï¼Œçœ‹ä¸œè¥¿å®¹æ˜“æ¨¡ç³Š ğŸ‘€", "æœ¨èƒ½é‡è¿‡å¼º"],
    14: ["èƒ¸å£ä¸¤ä¾§éšéšç¼ç—›ï¼Œå®¹æ˜“æ€¥èºå‘è„¾æ°” ğŸ¤¬", "æœ¨èƒ½é‡è¿‡å¼º"],
    15: ["å¤´æ™•çœ¼èŠ±ã€è€³æœµå—¡å—¡å“ï¼Œå¶å°”æ‰‹è„šæŠ½åŠ¨ ğŸŒ€", "æœ¨èƒ½é‡è¿‡å¼º"],
    16: ["å£å¹²å’½ç‡¥ï¼Œå˜´å”‡å¹²è£‚ï¼Œå¤œé‡Œç¡è§‰å¤šæ¢¦ ğŸŒ¬ï¸", "æœ¨èƒ½é‡è¿‡å¼º"],
    17: ["è…¹éƒ¨å†·ç—›ï¼Œå–œæ¬¢ç”¨çƒ­æ°´è¢‹æ‚è‚šå­ ğŸ›", "åœŸèƒ½é‡è¿‡å¼±"],
    18: ["å¤§ä¾¿ç¨€çƒ‚ä¸æˆå½¢ï¼Œåƒç‚¹å‡‰çš„å°±æ‹‰è‚šå­ ğŸ’©", "åœŸèƒ½é‡è¿‡å¼±"],
    19: ["æ²¡èƒƒå£ä¸æƒ³åƒé¥­ï¼Œé¥­åè‚šå­èƒ€å¾—å‰å®³ ğŸ¤¢", "åœŸèƒ½é‡è¿‡å¼±"],
    20: ["èº«ä½“ä¹åŠ›æ‡’å¾—è¯´è¯ï¼Œè„¸ä¸Šå‘é»„æ²¡æ°”è‰² ğŸ¥º", "åœŸèƒ½é‡è¿‡å¼±"],
    21: ["è‚šå­éšéšç¼ç—›ï¼Œé¥¿äº†ä¹Ÿä¸æƒ³åƒä¸œè¥¿ ğŸ”¥", "åœŸèƒ½é‡è¿‡å¼º"],
    22: ["å¤§ä¾¿å¹²ç»“åƒç¾Šå±ï¼Œæ’ä¾¿ç‰¹åˆ«å›°éš¾ ğŸš½", "åœŸèƒ½é‡è¿‡å¼º"],
    23: ["åƒä¸€ç‚¹æ¸©çƒ­çš„ä¸œè¥¿ï¼Œå°±è§‰å¾—ä¸Šç«éš¾å— ğŸ¥µ", "åœŸèƒ½é‡è¿‡å¼º"],
    24: ["é•¿æœŸå£å¹²ï¼Œå–æ°´ä¹Ÿåªèƒ½çŸ­æš‚ç¼“è§£ ğŸ¥¤", "åœŸèƒ½é‡è¿‡å¼º"],
    25: ["å’³å—½æ²¡åŠ›æ°”ï¼Œç—°æ˜¯ç™½è‰²çš„ã€æ¯”è¾ƒç¨€ ğŸ¤§", "é‡‘èƒ½é‡è¿‡å¼±"],
    26: ["åèƒŒç‰¹åˆ«æ€•å†·ï¼Œä¸€å¹å†·é£å°±æ„Ÿå†’ ğŸ¤’", "é‡‘èƒ½é‡è¿‡å¼±"],
    27: ["è¯´è¯å£°éŸ³ä½å¾®ï¼Œç¨å¾®æ´»åŠ¨å°±æ°”å–˜åå ğŸ«", "é‡‘èƒ½é‡è¿‡å¼±"],
    28: ["å…ç–«åŠ›å·®ï¼Œä¸€å¹´å››å­£åå¤æ„Ÿå†’ ğŸ¦ ", "é‡‘èƒ½é‡è¿‡å¼±"],
    29: ["å¹²å’³æ²¡æœ‰ç—°ï¼Œæˆ–ç—°å°‘é»è…»éš¾å’³å‡ºæ¥ ğŸ§´", "é‡‘èƒ½é‡è¿‡å¼º"],
    30: ["å’½å–‰å¹²ç—›ã€å£°éŸ³å˜¶å“‘ï¼Œæ€»è§‰å¾—æœ‰å¼‚ç‰© ğŸ—£ï¸", "é‡‘èƒ½é‡è¿‡å¼º"],
    31: ["ä¸‹åˆè„¸é¢Šå‘çº¢ï¼Œå¤œé‡Œç¡è§‰å·å·å‡ºæ±— ğŸ¥µ", "é‡‘èƒ½é‡è¿‡å¼º"],
    32: ["ç§‹å†¬å­£èŠ‚ï¼Œé¼»è…”å¹²ç‡¥å®¹æ˜“å‡ºè¡€ ğŸ©¸", "é‡‘èƒ½é‡è¿‡å¼º"],
    33: ["è…°å’Œè†ç›–é…¸è½¯å†·ç—›ï¼Œä¸‹è‚¢ç‰¹åˆ«æ€•å†· ğŸ¦µ", "æ°´èƒ½é‡è¿‡å¼±"],
    34: ["å°ä¾¿æ¸…ç¨€é‡å¤šï¼Œå¤œé‡Œé¢‘ç¹èµ·å¤œä¸Šå•æ‰€ ğŸš½", "æ°´èƒ½é‡è¿‡å¼±"],
    35: ["ç²¾ç¥èé¡æ€»æƒ³ç¡è§‰ï¼Œæµ‘èº«æä¸èµ·åŠ² ğŸ¥±", "æ°´èƒ½é‡è¿‡å¼±"],
    36: ["å¤©ä¸äº®å°±æ‹‰è‚šå­ï¼Œå¤§ä¾¿æœ‰æœªæ¶ˆåŒ–é£Ÿç‰© ğŸŒ…", "æ°´èƒ½é‡è¿‡å¼±"],
    37: ["è…°å’Œè†ç›–é…¸ç—›æ— åŠ›ï¼Œè®°å¿†åŠ›æ˜æ˜¾ä¸‹é™ ğŸ§ ", "æ°´èƒ½é‡è¿‡å¼º"],
    38: ["ä¸‹åˆèº«ä½“æ½®çƒ­ï¼Œæ‰‹å¿ƒè„šå¿ƒä¸€ç›´å‘çƒ­ ğŸ¥µ", "æ°´èƒ½é‡è¿‡å¼º"],
    39: ["å¤±çœ å¤šæ¢¦æ˜“é†’ï¼Œç¡è§‰è´¨é‡ç‰¹åˆ«å·® ğŸ˜´", "æ°´èƒ½é‡è¿‡å¼º"],
    40: ["å£å¹²å’½ç‡¥å°ä¾¿é»„ï¼Œå¤´å‘æ—©ç™½è¿˜å®¹æ˜“æ‰ ğŸ¦³", "æ°´èƒ½é‡è¿‡å¼º"],
}

TAG_GROUPS = {
    "ç«èƒ½é‡è¿‡å¼±": [1,2,3,4],
    "ç«èƒ½é‡è¿‡å¼º": [5,6,7,8],
    "æœ¨èƒ½é‡è¿‡å¼±": [9,10,11,12],
    "æœ¨èƒ½é‡è¿‡å¼º": [13,14,15,16],
    "åœŸèƒ½é‡è¿‡å¼±": [17,18,19,20],
    "åœŸèƒ½é‡è¿‡å¼º": [21,22,23,24],
    "é‡‘èƒ½é‡è¿‡å¼±": [25,26,27,28],
    "é‡‘èƒ½é‡è¿‡å¼º": [29,30,31,32],
    "æ°´èƒ½é‡è¿‡å¼±": [33,34,35,36],
    "æ°´èƒ½é‡è¿‡å¼º": [37,38,39,40],
}

# ---------------------- æ ¸å¿ƒè®¡ç®—é€»è¾‘ ----------------------
def calculate_result(answers):
    tag_scores = {tag: 0 for tag in TAG_GROUPS.keys()}
    for tag, qnos in TAG_GROUPS.items():
        for qno in qnos:
            tag_scores[tag] += answers.get(qno, 1)

    element_results = {}
    elements = ["ç«", "æœ¨", "åœŸ", "é‡‘", "æ°´"]
    for ele in elements:
        weak_score = tag_scores[f"{ele}èƒ½é‡è¿‡å¼±"]
        strong_score = tag_scores[f"{ele}èƒ½é‡è¿‡å¼º"]

        if weak_score >= 8 and (weak_score - strong_score) >= 2:
            element_results[ele] = {"ç±»å‹": "èƒ½é‡è¿‡å¼±"}
        elif strong_score >= 8 and (strong_score - weak_score) >= 2:
            element_results[ele] = {"ç±»å‹": "èƒ½é‡è¿‡å¼º"}
        elif weak_score >= 8 or strong_score >= 8:
            element_results[ele] = {"ç±»å‹": "èƒ½é‡è¿‡å¼±"}
        else:
            element_results[ele] = {"ç±»å‹": "èƒ½é‡å¹³è¡¡"}

    # ç”Ÿæˆå±•ç¤ºæ–‡æœ¬
    biased_elements = [(ele, res) for ele, res in element_results.items() if res["ç±»å‹"] != "èƒ½é‡å¹³è¡¡"]
    biased_elements.sort(key=lambda x: x[0], reverse=False)
    
    result_text = "### äº”è¡Œèƒ½é‡çŠ¶æ€æµ‹è¯„å·²æˆåŠŸä¸Šä¼ ï¼Œæˆªå›¾å‘ç»™ç­ç­è€å¸ˆå³å¯\n\n"
    if not biased_elements:
        result_text += "âœ… ä½ çš„äº”è¡Œèƒ½é‡æš‚æ—¶å¤„äºå¹³è¡¡çŠ¶æ€ï¼Œèº«ä½“åŸºç¡€çŠ¶å†µè‰¯å¥½ï¼\n"
    else:
        result_text += "ğŸ” ä½ çš„èº«ä½“èƒ½é‡çŠ¶æ€ï¼š\n"
        for i, (ele, res) in enumerate(biased_elements[:3], 1):
            result_text += f"{i}. {ele}ï¼š{res['ç±»å‹']}\n"

        if len(biased_elements) > 3:
            result_text += "\nğŸŸ¡ å…¶ä»–èƒ½é‡çŠ¶æ€ï¼š\n"
            for ele, res in biased_elements[3:]:
                result_text += f"- {ele}ï¼š{res['ç±»å‹']}\n"

    return result_text, element_results

# ---------------------- é¢˜ç›®å±•ç¤º ----------------------
answers = {}
col1, col2 = st.columns(2, gap="large")

for qno in sorted(QUESTIONS.keys()):
    qtext, _ = QUESTIONS[qno]
    if qno % 2 == 1:
        with col1:
            score = st.radio(
                qtext,
                options=[1,2,3,4,5],
                format_func=lambda x: ["å®Œå…¨æ²¡æœ‰","è½»åº¦","ä¸­åº¦","ä¸¥é‡","å¾ˆä¸¥é‡"][x-1],
                key=f"q{qno}",
                horizontal=True
            )
            answers[qno] = score
    else:
        with col2:
            score = st.radio(
                qtext,
                options=[1,2,3,4,5],
                format_func=lambda x: ["å®Œå…¨æ²¡æœ‰","è½»åº¦","ä¸­åº¦","ä¸¥é‡","å¾ˆä¸¥é‡"][x-1],
                key=f"q{qno}",
                horizontal=True
            )
            answers[qno] = score

st.divider()

# ---------------------- æäº¤æŒ‰é’®é€»è¾‘ï¼ˆä¿®å¤disabledæŠ¥é”™ï¼‰ ----------------------
# 1. æ£€æŸ¥æ˜¯å¦å·²æäº¤
is_submitted = check_submitted()
# 2. æ£€æŸ¥æ˜µç§°æ˜¯å¦å¡«å†™
is_name_empty = len(wechat_name.strip()) == 0
# 3. ç¡®å®šæŒ‰é’®æ˜¯å¦ç¦ç”¨
btn_disabled = is_submitted or is_name_empty

# æ˜¾ç¤ºé‡å¤æäº¤æç¤º
if is_submitted:
    st.info("ğŸ’¡ ä½ å·²æäº¤è¿‡æµ‹è¯„ç»“æœï¼Œæ¯äººä»…å¯æäº¤ä¸€æ¬¡ï¼")

# æäº¤æŒ‰é’®
submit_btn = st.button(
    "ğŸ” æäº¤æµ‹è¯„ Â· æŸ¥çœ‹æˆ‘çš„èƒ½é‡ç»“æœ",
    type="primary",
    use_container_width=True,
    disabled=btn_disabled
)

# æäº¤é€»è¾‘
if submit_btn and not btn_disabled:
    # è®¡ç®—ç»“æœ
    result_text, element_results = calculate_result(answers)
    # è·³è½¬é£ä¹¦è¡¨å•æäº¤æ•°æ®
    submit_to_feishu_form(wechat_name, element_results)
    # æ ‡è®°å·²æäº¤
    mark_submitted(wechat_name.strip())
    # å±•ç¤ºç»“æœ
    st.markdown("---")
    with st.container(border=True):
        st.markdown(result_text)
elif submit_btn and is_name_empty:
    st.error("âŒ è¯·å…ˆå¡«å†™å¾®ä¿¡æ˜µç§°å†æäº¤ï¼")

# ---------------------- åº•éƒ¨æç¤º ----------------------
st.markdown("""
<div style="text-align: center; margin-top: 20px; color: #666;">
    <p>æäº¤åè¯·æˆªå›¾ç»“æœå‘ç»™ç­ç­è€å¸ˆï¼Œæ„Ÿè°¢é…åˆ ğŸ’–</p>
</div>
""", unsafe_allow_html=True)